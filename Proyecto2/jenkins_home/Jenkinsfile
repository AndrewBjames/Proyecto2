pipeline {
  agent any
  options { timestamps() }

  environment {
    IMAGE_REPO = "bkbigmac/proyectofinal2"
    SERVICE_NAME = "app"
    COMPOSE_FILE = "docker-compose.yml"
    DOCKER_CREDS_ID = "dockerhub-creds"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build imagen (Docker Compose)') {
      steps {
        bat """
@echo on
echo ===== BUILD =====
docker compose -f %COMPOSE_FILE% build %SERVICE_NAME% || docker-compose -f %COMPOSE_FILE% build %SERVICE_NAME%
IF %ERRORLEVEL% NEQ 0 EXIT /B 1
"""
      }
    }

    stage('Tag + Push a Docker Hub') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: DOCKER_CREDS_ID,
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          bat """
@echo on
echo ===== PUSH =====

REM Tags identificables
set TAG1=student-bkbigmac
set TAG2=student-bkbigmac-build-%BUILD_NUMBER%

REM Login
echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

REM Obtener IMAGE ID del servicio
for /f "tokens=2" %%i in ('docker compose images %SERVICE_NAME% ^| findstr /R "^[a-zA-Z]"') do set IMG_ID=%%i
if "%IMG_ID%"=="" (
  echo ERROR: No se pudo obtener IMAGE ID
  EXIT /B 1
)

REM Tag
docker tag %IMG_ID% %IMAGE_REPO%:%TAG1%
docker tag %IMG_ID% %IMAGE_REPO%:%TAG2%

REM Push
docker push %IMAGE_REPO%:%TAG1% || EXIT /B 1
docker push %IMAGE_REPO%:%TAG2% || EXIT /B 1

echo Push completado correctamente
"""
        }
      }
    }
  }

  post {
    always {
      bat """
@echo on
echo ===== FIN DEL PIPELINE =====
"""
    }
  }
}


