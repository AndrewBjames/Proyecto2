pipeline {
  agent any
  options { timestamps() }   // hora en los logs

  environment {
    // docker-compose vive dentro de la carpeta Proyecto2
    COMPOSE_FILE = "Proyecto2/docker-compose.yml"

    // credenciales Docker Hub en Jenkins (Username/Password)
    DOCKER_CREDS_ID = "dockerhub-creds"

    // tags (ya los estás generando con docker compose; aquí solo los usamos para verificar)
    IMG1 = "bkbigmac/proyectofinal2:imagen1"
    IMG2 = "bkbigmac/proyectofinal2:imagen2"
    IMG3 = "bkbigmac/proyectofinal2:imagen3"
    IMG4 = "bkbigmac/proyectofinal2:imagen4"
    IMG5 = "bkbigmac/proyectofinal2:imagen5"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build (5 imágenes)') {
      steps {
        bat """
@echo on
echo ===== BUILD (5 IMAGENES) =====
docker compose -f "%COMPOSE_FILE%" build
IF %ERRORLEVEL% NEQ 0 EXIT /B 1
"""
      }
    }

    stage('Verificación (mostrar instalaciones)') {
      steps {
        bat """
@echo on
echo ===== VERIFICACION DE HERRAMIENTAS (LOGS) =====

echo.
echo --- Imagen 1 (RPM) ---
docker run --rm %IMG1% rpm --version
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

echo.
echo --- Imagen 2 (Ruby + rbenv) ---
docker run --rm %IMG2% bash -lc "rbenv --version && ruby -v" || docker run --rm %IMG2% sh -lc "rbenv --version && ruby -v"
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

echo.
echo --- Imagen 3 (Node + Yarn) ---
docker run --rm %IMG3% bash -lc "node -v && npm -v && yarn -v" || docker run --rm %IMG3% sh -lc "node -v && npm -v && yarn -v"
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

echo.
echo --- Imagen 4 (Python + pip) ---
docker run --rm %IMG4% bash -lc "python3 --version && pip3 --version" || docker run --rm %IMG4% sh -lc "python3 --version && pip3 --version"
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

echo.
echo --- Imagen 5 (FULL: RPM + Ruby/rbenv + Node/Yarn + Python) ---
docker run --rm %IMG5% bash -lc "rpm --version && rbenv --version && ruby -v && node -v && yarn -v && python3 --version && pip3 --version" || docker run --rm %IMG5% sh -lc "rpm --version && rbenv --version && ruby -v && node -v && yarn -v && python3 --version && pip3 --version"
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

echo.
echo ===== VERIFICACION OK =====
"""
      }
    }

    stage('Login Docker Hub') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: DOCKER_CREDS_ID,
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          bat """
@echo on
echo ===== LOGIN DOCKER HUB =====
echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin
IF %ERRORLEVEL% NEQ 0 EXIT /B 1
"""
        }
      }
    }

    stage('Push (5 imágenes)') {
      steps {
        bat """
@echo on
echo ===== PUSH (5 IMAGENES) =====
docker compose -f "%COMPOSE_FILE%" push
IF %ERRORLEVEL% NEQ 0 EXIT /B 1
"""
      }
    }
  }

  post {
    always {
      bat """
@echo on
echo ===== FIN DEL PIPELINE =====
"""
    }
  }
}
