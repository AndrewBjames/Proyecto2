pipeline {
  agent any
  options { timestamps() }   // Muestra la hora en los logs

  environment {
    // Ruta del docker-compose dentro del repositorio
    COMPOSE_FILE = "Proyecto2/docker-compose.yml"

    // Credenciales de Docker Hub guardadas en Jenkins
    DOCKER_CREDS_ID = "dockerhub-creds"
  }

  stages {

    stage('Checkout') {
      steps {
        // Descarga el código desde GitHub
        checkout scm
      }
    }

    stage('Build (5 imágenes)') {
      steps {
        bat """
@echo on
echo ===== BUILD (5 IMAGENES) =====
docker compose -f "%COMPOSE_FILE%" build
IF %ERRORLEVEL% NEQ 0 EXIT /B 1
"""
      }
    }

    stage('Verificación de herramientas') {
      steps {
        bat """
@echo on
echo ===== VERIFICACION =====

echo --- Imagen 1: RPM ---
docker compose -f "%COMPOSE_FILE%" run --rm imagen1-rpm sh -lc "rpm --version && rpmbuild --version"
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

echo --- Imagen 2: Ruby ---
docker compose -f "%COMPOSE_FILE%" run --rm imagen2-ruby sh -lc "rbenv --version && ruby -v || echo Ruby no instalado"
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

echo --- Imagen 3: Node ---
docker compose -f "%COMPOSE_FILE%" run --rm imagen3-node sh -lc "node -v && npm -v && yarn -v"
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

echo --- Imagen 4: Python ---
docker compose -f "%COMPOSE_FILE%" run --rm imagen4-python sh -lc "python3 --version && pip3 --version"
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

echo --- Imagen 5: Full Stack ---
docker compose -f "%COMPOSE_FILE%" run --rm imagen5-full sh -lc "node -v && python3 --version && rbenv --version && ruby -v || echo Ruby no instalado"
IF %ERRORLEVEL% NEQ 0 EXIT /B 1

echo ===== VERIFICACION COMPLETADA =====
"""
      }
    }

    stage('Login Docker Hub') {
      steps {
        // Inicia sesión en Docker Hub usando credenciales de Jenkins
        withCredentials([usernamePassword(
          credentialsId: DOCKER_CREDS_ID,
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          bat """
@echo on
echo ===== LOGIN DOCKER HUB =====
echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin
IF %ERRORLEVEL% NEQ 0 EXIT /B 1
"""
        }
      }
    }

    stage('Push (5 imágenes)') {
      steps {
        bat """
@echo on
echo ===== PUSH (5 IMAGENES) =====
docker compose -f "%COMPOSE_FILE%" push
IF %ERRORLEVEL% NEQ 0 EXIT /B 1
"""
      }
    }
  }

  post {
    always {
      bat """
@echo on
echo ===== FIN DEL PIPELINE =====
"""
    }
  }
}
